<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8" />
    <title>gRPC gateway</title>
  </head>
  <body>
    <script type="text/javascript">
      // fetch('/example.Example/Echo', {
      //   method: 'POST',
      //   body: JSON.stringify({ date: Date.now() }),
      //   headers: {
      //     'content-type': 'application/json'
      //   }
      // })
      //   .then((res) => res.json())
      //   .then(console.log.bind(console, 'echo response'))
      //   .catch(console.error.bind(console))

      const ws = new WebSocket(
        'ws://localhost:8080/example.Example/BidiStream',
      );

      let isAlive = true;
      let interval = null;
      const pingTimeout = 5000;

      ws.onopen = () => {
        ws.send(JSON.stringify({ date: Date.now() }));
        interval = setInterval(() => {
          if (!isAlive) {
            ws.close();
            return;
          }
          isAlive = false;
          ws.send(JSON.stringify({ ping: true }));
        }, pingTimeout);
      }
      ws.onerror = console.error.bind(console);
      ws.onmessage = (msg) => {
        try {
          const message = JSON.parse(msg.data);
          console.log('echo stream message: ', message);
          if (message.ping) {
            ws.send(JSON.stringify({ pong: true }));
          } else if (message.pong) {
            isAlive = true;
          }
        } catch (e) {
          console.error(e);
        }
      }
      ws.onclose = () => {
        console.log("Connection closed");
        clearInterval(interval);
      }
    </script>
  </body>
</html>
